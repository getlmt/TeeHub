import React, { useRef, useEffect, useState } from 'react';
import { Camera, Settings, ZoomIn, Upload, ShoppingBag } from 'lucide-react';
import './VirtualTryOn.css';
import { productService } from '../../../services/productService';

// === C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N ·∫¢NH ===
// ƒê√¢y l√† ƒë·ªãa ch·ªâ Frontend c·ªßa b·∫°n (n∆°i ch·ª©a th∆∞ m·ª•c public/Product)
// Python Backend c·∫ßn ƒë·ªãa ch·ªâ n√†y ƒë·ªÉ t·∫£i ·∫£nh v·ªÅ x·ª≠ l√Ω.
const FRONTEND_BASE_URL = 'http://localhost:5173';

const VirtualTryOn = () => {
  const videoRef = useRef(null);
  const [isInitialized, setIsInitialized] = useState(false);
  const [isStreaming, setIsStreaming] = useState(false);
  const [scale, setScale] = useState(0.6);
  const [error, setError] = useState('');

  // State qu·∫£n l√Ω ƒë∆∞·ªùng d·∫´n √°o
  const [clothPath, setClothPath] = useState('./ao3.png'); // M·∫∑c ƒë·ªãnh v·∫´n gi·ªØ file local ƒë·ªÉ test
  const [customPath, setCustomPath] = useState('');

  // State l∆∞u danh s√°ch s·∫£n ph·∫©m t·ª´ Shop
  const [shopProducts, setShopProducts] = useState([]);

  // 1. L·∫§Y DANH S√ÅCH S·∫¢N PH·∫®M T·ª™ SHOP KHI V√ÄO TRANG
  useEffect(() => {
    const fetchProducts = async () => {
      try {
        // L·∫•y 6 s·∫£n ph·∫©m m·ªõi nh·∫•t ƒë·ªÉ hi·ªÉn th·ªã
        const response = await productService.getAllProducts(1, 6);
        // Ki·ªÉm tra xem API tr·∫£ v·ªÅ d·∫°ng Page (response.content) hay List (response)
        const products = response.content || response || [];
        setShopProducts(products);
      } catch (err) {
        console.error("L·ªói l·∫•y s·∫£n ph·∫©m shop:", err);
      }
    };

    fetchProducts();

    // Kh·ªüi t·∫°o backend v·ªõi √°o m·∫∑c ƒë·ªãnh
    initializeBackend(clothPath);
  }, []);

  // 2. LOGIC KH·ªûI T·∫†O BACKEND (G·ª≠i path ho·∫∑c URL sang Python)
  const initializeBackend = async (path) => {
    try {
      const response = await fetch('http://localhost:5000/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cloth_path: path })
      });
      const data = await response.json();
      if (data.status === 'success') {
        setIsInitialized(true);
        setError('');
        setClothPath(path);
        return true;
      } else {
        setError(data.message);
        return false;
      }
    } catch (err) {
      setError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server Python (Flask). H√£y ch·∫°y app.py!');
      return false;
    }
  };

  // 3. X·ª¨ L√ù KHI CH·ªåN S·∫¢N PH·∫®M T·ª™ SHOP
  const handleSelectShopProduct = (product) => {
    // T√™n ·∫£nh trong DB (v√≠ d·ª•: "ao_thun.jpg")
    const imageName = product.productMainImage;

    if (!imageName) {
      alert("S·∫£n ph·∫©m n√†y kh√¥ng c√≥ ·∫£nh!");
      return;
    }

    // T·∫°o ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·ªÉ g·ª≠i sang Python
    // Python c·∫ßn: http://localhost:5173/Product/ten_anh.jpg
    let fullUrlForBackend = imageName;
    if (!imageName.startsWith('http')) {
      fullUrlForBackend = `${FRONTEND_BASE_URL}/Product/${imageName}`;
    }

    // C·∫≠p nh·∫≠t √¥ input ƒë·ªÉ user th·∫•y link
    setCustomPath(fullUrlForBackend);

    // G·ªçi h√†m ƒë·ªïi √°o
    changeCloth(fullUrlForBackend);
  };

  // 4. H√ÄM ƒê·ªîI √ÅO CHUNG
  const changeCloth = async (pathOverride = null) => {
    const path = pathOverride || customPath;

    if (!path) {
      setError('Vui l√≤ng ch·ªçn √°o ho·∫∑c nh·∫≠p ƒë∆∞·ªùng d·∫´n!');
      return;
    }

    // N·∫øu ƒëang stream th√¨ t·∫°m d·ª´ng ƒë·ªÉ backend load model m·ªõi
    if (isStreaming) {
      await stopStreaming();
    }

    const success = await initializeBackend(path);
    if (success) {
      setError('');
      // T·ª± ƒë·ªông b·∫≠t l·∫°i stream n·∫øu mu·ªën (b·ªè comment d√≤ng d∆∞·ªõi)
      // await startStreaming();
    }
  };

  // B·∫Øt ƒë·∫ßu streaming
  const startStreaming = async () => {
    if (!isInitialized) {
      setError('Vui l√≤ng kh·ªüi t·∫°o √°o tr∆∞·ªõc!');
      return;
    }

    try {
      const response = await fetch('http://localhost:5000/start_stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();

      if (data.status === 'success') {
        setIsStreaming(true);
        setError('');

        if (videoRef.current) {
          // Th√™m timestamp ƒë·ªÉ tr√°nh cache tr√¨nh duy·ªát
          videoRef.current.src = `http://localhost:5000/video_feed?t=${Date.now()}`;
        }
      } else {
        setError(data.message);
      }
    } catch (err) {
      setError('L·ªói start stream: ' + err.message);
    }
  };

  // D·ª´ng streaming
  const stopStreaming = async () => {
    try {
      await fetch('http://localhost:5000/stop_stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      setIsStreaming(false);
      if (videoRef.current) {
        videoRef.current.src = '';
      }
    } catch (err) {
      setError('L·ªói stop stream: ' + err.message);
    }
  };

  const toggleStreaming = () => {
    if (isStreaming) {
      stopStreaming();
    } else {
      startStreaming();
    }
  };

  const updateSettings = async (newScale) => {
    try {
      await fetch('http://localhost:5000/update_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scale: newScale })
      });
    } catch (err) {
      console.error('Error updating settings:', err);
    }
  };

  useEffect(() => {
    if (isInitialized) {
      updateSettings(scale);
    }
  }, [scale]);

  return (
    <div className="virtual-tryon-container">
      <div className="virtual-tryon-wrapper">
        {/* Header */}
        <div className="header">
          <h1 className="header-title">
            <Camera className="w-12 h-12" />
            Virtual Try-On AI
          </h1>
          <p className="header-subtitle">Th·ª≠ ƒë·ªì tr·ª±c tuy·∫øn v·ªõi AI</p>
        </div>

        {/* Error Message */}
        {error && (
          <div className="error-message">
            <p className="error-title">‚ö†Ô∏è Th√¥ng b√°o:</p>
            <p>{error}</p>
          </div>
        )}

        {/* Main Content */}
        <div className="main-grid">
          {/* Video Display */}
          <div>
            <div className="video-panel">
              <div className="video-container">
                <img
                  ref={videoRef}
                  alt="Video Stream"
                  className="video-stream"
                  style={{ minHeight: '480px', background: '#000' }}
                />

                <div className={`status-badge ${isInitialized ? 'status-ready' : 'status-connecting'}`}>
                  {isInitialized ? '‚úì √Åo ƒë√£ s·∫µn s√†ng' : '‚è≥ ƒêang t·∫£i √°o...'}
                </div>

                {isStreaming && (
                  <div className="streaming-badge">
                    <div className="pulse-dot"></div>
                    LIVE
                  </div>
                )}
              </div>

              <div className="control-button-container">
                <button
                  onClick={toggleStreaming}
                  disabled={!isInitialized}
                  className={`control-button ${isStreaming ? 'streaming' : 'ready'}`}
                >
                  {isStreaming ? '‚è∏ D·ª´ng Th·ª≠ ƒê·ªì' : '‚ñ∂ B·∫Øt ƒê·∫ßu Th·ª≠ ƒê·ªì'}
                </button>
              </div>
            </div>
          </div>

          {/* Settings Panel */}
          <div className="settings-container">

            {/* --- PH·∫¶N CH·ªåN S·∫¢N PH·∫®M T·ª™ SHOP (M·ªöI) --- */}
            <div className="panel">
              <div className="panel-header">
                <ShoppingBag className="w-6 h-6 text-blue-300" />
                <h3 className="panel-title">S·∫£n ph·∫©m t·ª´ Shop</h3>
              </div>

              <div>
                <div className="input-group">
                  <label className="input-label">Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ th·ª≠:</label>

                  {shopProducts.length === 0 ? (
                    <p style={{ color: '#9ca3af', fontSize: '0.9rem', fontStyle: 'italic' }}>
                      ƒêang t·∫£i danh s√°ch s·∫£n ph·∫©m...
                    </p>
                  ) : (
                    <div className="quick-select-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                      {shopProducts.map((prod) => {
                        // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã tr√™n Frontend
                        const imgName = prod.productMainImage;
                        let displayUrl = '/placeholder.png'; // ·∫¢nh m·∫∑c ƒë·ªãnh n·∫øu l·ªói

                        if (imgName) {
                          if (imgName.startsWith('http')) {
                            displayUrl = imgName;
                          } else {
                            // ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi gi·ªëng trang Product Detail
                            displayUrl = `/Product/${imgName}`;
                          }
                        }

                        const isSelected = clothPath.includes(imgName);

                        return (
                          <div
                            key={prod.productId}
                            className="product-item"
                            onClick={() => handleSelectShopProduct(prod)}
                            style={{
                              cursor: 'pointer',
                              textAlign: 'center',
                              opacity: isStreaming ? 0.5 : 1 // L√†m m·ªù khi ƒëang stream ƒë·ªÉ user bi·∫øt c·∫ßn d·ª´ng stream m·ªõi ƒë·ªïi ƒë∆∞·ª£c
                            }}
                            title={prod.productName}
                          >
                            <div style={{
                              width: '100%',
                              height: '90px',
                              overflow: 'hidden',
                              borderRadius: '8px',
                              border: isSelected ? '3px solid #3b82f6' : '1px solid #374151',
                              background: '#1f2937',
                              transition: 'all 0.2s'
                            }}>
                              <img
                                src={displayUrl}
                                alt={prod.productName}
                                style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                onError={(e) => { e.target.src = 'https://via.placeholder.com/150?text=No+Image' }}
                              />
                            </div>
                            <p style={{
                              fontSize: '0.75rem',
                              marginTop: '6px',
                              whiteSpace: 'nowrap',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis',
                              color: isSelected ? '#60a5fa' : '#e5e7eb',
                              fontWeight: isSelected ? 'bold' : 'normal'
                            }}>
                              {prod.productName}
                            </p>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Ph·∫ßn nh·∫≠p link th·ªß c√¥ng (Gi·ªØ l·∫°i ƒë·ªÉ debug n·∫øu c·∫ßn) */}
                <div className="input-group" style={{ marginTop: '1.5rem', borderTop: '1px solid #374151', paddingTop: '1rem' }}>
                  <label className="input-label">Ho·∫∑c nh·∫≠p link ·∫£nh kh√°c:</label>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <input
                      type="text"
                      value={customPath}
                      onChange={(e) => setCustomPath(e.target.value)}
                      placeholder="https://example.com/ao.png"
                      className="text-input"
                    />
                    <button
                      onClick={() => changeCloth(customPath)}
                      disabled={!customPath || isStreaming}
                      className={`change-button ${customPath && !isStreaming ? 'enabled' : 'disabled'}`}
                      style={{ width: 'auto', padding: '0 12px' }}
                    >
                      üîÑ
                    </button>
                  </div>
                </div>

              </div>
            </div>
            {/* --- H·∫æT PH·∫¶N SHOP --- */}

            {/* Scale Control */}
            <div className="panel">
              <div className="panel-header">
                <Settings className="w-6 h-6 text-blue-300" />
                <h3 className="panel-title">ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc</h3>
              </div>

              <div className="slider-container">
                <div className="slider-header">
                  <label className="slider-label">
                    <ZoomIn className="w-5 h-5" />
                    Size √°o:
                  </label>
                  <span className="slider-value">{Math.round(scale * 100)}%</span>
                </div>
                <input
                  type="range"
                  min="0.5"
                  max="1.2"
                  step="0.05"
                  value={scale}
                  onChange={(e) => setScale(parseFloat(e.target.value))}
                  className="slider"
                />
                <div className="slider-labels">
                  <span>Nh·ªè</span>
                  <span>V·ª´a</span>
                  <span>L·ªõn</span>
                </div>
              </div>
            </div>

            {/* Guide */}
            <div className="panel">
              <h3 className="panel-title">üìù H∆∞·ªõng d·∫´n</h3>
              <ul className="instruction-list">
                <li>‚Ä¢ Ch·ªçn √°o t·ª´ danh s√°ch b√™n tr√™n.</li>
                <li>‚Ä¢ B·∫•m "B·∫Øt ƒê·∫ßu Th·ª≠ ƒê·ªì".</li>
                <li>‚Ä¢ ƒê·ª©ng c√°ch xa camera kho·∫£ng 1.5m - 2m.</li>
                <li>‚Ä¢ ƒêi·ªÅu ch·ªânh thanh tr∆∞·ª£t ƒë·ªÉ √°o v·ª´a v·∫∑n h∆°n.</li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
};

export default VirtualTryOn;